---
title: "R project"
author: "Pablo Martínez and Oriol Bustos"
date: "2024-03-15"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(ggplot2)
library(tibble)
library(corrplot)
library(dplyr)
library(caret)
```

## R Project

The first thing we do is to import the dataset from the directory: 

```{r}
data<-read.csv("Life_Expectancy_Data.csv")
```

As we can observe, the data is already downloaded as a dataframe format. Now we should transform this dataframe to a tibble format: 


```{r}
df_tib = as_tibble(data)
```

We start with the step of cleanning our data:

- Remove the 'NAN' values (deletes the whole row): 
```{r}
clean_df<- na.omit(df_tib)
```

Now we work towards a dataset with the same data types and non 'NAN' values. 

Lets work with dplyr library to explore data:


Let's explore the LifeExtacncy evolution between 2002 and 2005: 

```{r}
start_year = 2000
end_year = 2015

subset_0205 <- clean_df %>%
  filter(Year >= start_year, Year <= end_year) %>%
  group_by(Year)

subset_averageLifeExpectancy <- clean_df %>%
  filter(Year >= start_year, Year <= end_year) %>%
  group_by(Year)%>%
  summarise(AverageLifeExpectancy = mean(Life.expectancy, na.rm = TRUE))
```

```{r}
ggplot(subset_0205, aes(x=Year, y= Life.expectancy))+geom_col()+expand_limits(y=0)

ggplot(subset_averageLifeExpectancy, aes(x=Year, y= AverageLifeExpectancy))+geom_col()+expand_limits(y=0)
```
We can see that in between 2002 and 2005 the Life Expectancy increases with the years.

Now let's explore which are the variables that are mostly correlated to the Life Expectancy in general: 

To run the correlation, all the dataframe values must be 'numeric' type, so we tranform the int values to numeric and remove the character variables to do this analysis, we will lose information about the country and the status, but we will perform a further analysis on that in the following steps:

```{r}
correlation_df<-clean_df
correlation_df$Year <- as.numeric(correlation_df$Year)
correlation_df$Adult.Mortality <- as.numeric(correlation_df$Adult.Mortality )
correlation_df$infant.deaths <- as.numeric(correlation_df$infant.deaths)
correlation_df$Hepatitis.B <- as.numeric(correlation_df$Hepatitis.B)
correlation_df$Measles <- as.numeric(correlation_df$Measles)
correlation_df$under.five.deaths <- as.numeric(correlation_df$under.five.deaths)
correlation_df$Polio <- as.numeric(correlation_df$Polio)
correlation_df$Diphtheria <- as.numeric(correlation_df$Diphtheria)
correlation_df<-correlation_df[ ,!(names(correlation_df) %in% c("Country", "Status"))]
```

```{r}
correlation_matrix<- cor(correlation_df)
corrplot(correlation_matrix, method="color", type="upper",
         tl.col = "black", tl.srt=45, tl.cex=0.5)
```
Among all these values, let's infer in which variables are more correlated with the Life Expectancy by taking only the 5 highest values in the correlation matrix, discarding the correlation of Life expectancy with itself obviously: 

```{r}
correlation_Life_Exp  <- correlation_matrix["Life.expectancy", ]

# sort the value in a decreasing order: 
ordered_vals <- sort(correlation_Life_Exp, decreasing = TRUE)

# imprimir los 5 valores máximos: 
print(ordered_vals)

```
After looking at the correlations, the top5 significant ones are: 
```{r}
ordered_vals[-1]
```

```{r}
highest_cor <- c(ordered_vals[2], ordered_vals[3], tail(ordered_vals, n=1), ordered_vals[length(ordered_vals)-1], ordered_vals[4])

```


Now let's explore in how Life Expectancy is affected in different continents in general: 

```{r}
Africa <- c(
  "Algeria", "Angola", "Benin", "Botswana", "Burkina Faso", "Burundi",
  "Cape Verde", "Cameroon", "Cabo Verde","Chad", "Comoros", "Democratic Republic of the Congo",
  "Djibouti", "Egypt", "Equatorial Guinea", "Eritrea", "Eswatini", "Ethiopia",
  "Gabon", "Gambia", "Ghana", "Guinea", "Guinea-Bissau", "Ivory Coast",
  "Kenya", "Lesotho", "Liberia", "Libya", "Madagascar", "Malawi", "Mali",
  "Mauritania", "Mauritius", "Morocco", "Mozambique", "Namibia", "Niger",
  "Nigeria", "Rwanda", "Sao Tome and Principe", "Senegal", "Seychelles",
  "Sierra Leone", "Somalia", "South Africa", "South Sudan", "Sudan", "Tanzania",
  "Togo", "Tunisia", "Uganda", "Zambia", "Zimbabwe","Central African Republic", "Swaziland")
Europe <- c(
  "Albania", "Andorra", "Armenia", "Austria", "Azerbaijan", 
  "Belarus", "Belgium", "Bosnia and Herzegovina", "Bulgaria",
  "Croatia", "Cyprus", "Czech Republic","Denmark","Estonia","Finland", "France","Georgia", "Germany", "Greece","Hungary","Iceland", "Ireland", "Italy","Kazakhstan", "Kosovo","Latvia", "Liechtenstein", "Lithuania", "Luxembourg","Malta", "Moldova", "Monaco", "Montenegro",  "Netherlands", "North Macedonia", "Norway","Poland", "Portugal","Romania", "Russia", "San Marino", "Serbia", "Slovakia", "Slovenia", "Spain", "Sweden","Switzerland","Turkey","Ukraine", "United Kingdom", "Vatican City","Russian Federation")

Asia <- c(
  "Afghanistan", "Armenia", "Azerbaijan", "Bahrain", "Bangladesh", "Bhutan",
  "Brunei", "Cambodia", "China", "Cyprus",
  "Georgia", "India", "Indonesia", "Iran", "Iraq", "Israel",
  "Japan", "Jordan",
  "Kazakhstan", "Kuwait", "Kyrgyzstan",
  "Laos", "Lebanon",
  "Malaysia", "Maldives", "Mongolia", "Myanmar",
  "Nepal", "North Korea",
  "Oman",
  "Pakistan", "Palestine", "Philippines",
  "Qatar",
  "Russia",
  "Saudi Arabia", "Singapore", "South Korea", "Sri Lanka", "Syria",
  "Taiwan", "Tajikistan", "Thailand", "Timor-Leste", "Turkey", "Turkmenistan",
  "United Arab Emirates", "Uzbekistan",
  "Vietnam",
  "Yemen","Syrian Arab Republic")

  Oceania <- c(
  "Australia", "Fiji",
  "Kiribati",
  "Marshall Islands", "Micronesia",
  "Nauru", "New Zealand",
  "Palau", "Papua New Guinea",
  "Samoa", "Solomon Islands",
  "Tonga", "Tuvalu",
  "Vanuatu")

  America <- c(
    "Antigua and Barbuda", "Argentina", "Bahamas", "Barbados", "Belize", "Bolivia", 
    "Brazil", "Canada", "Chile", "Colombia", "Costa Rica", "Cuba", "Dominica", 
    "Dominican Republic", "Ecuador", "El Salvador", "Grenada", "Guatemala", "Guyana", 
    "Haiti", "Honduras", "Jamaica", "Mexico", "Nicaragua", "Panama", "Paraguay", 
    "Peru", "Saint Kitts and Nevis", "Saint Lucia", "Saint Vincent and the Grenadines", 
    "Suriname", "Trinidad and Tobago", "United States", "Uruguay", "Venezuela")
```

```{r}
  subset_continents <- clean_df %>%
mutate(Continent = case_when(
    Country %in% Africa ~ "Africa",
    Country %in% Europe ~ "Europe",
    Country %in% Asia ~ "Asia",
    Country %in% America ~ "America",
    Country %in% Oceania ~ "Oceania",
    TRUE ~ "Other")) %>%
  group_by(Continent)
  
  countries_classified_other <- subset_continents %>%
  filter(Continent == "Other") %>%
  distinct(Country) %>%
  pull(Country)

print(countries_classified_other)
```

```{r}
subset_continents <- clean_df %>%
mutate(Continent = case_when(
    Country %in% Africa ~ "Africa",
    Country %in% Europe ~ "Europe",
    Country %in% Asia ~ "Asia",
    Country %in% America ~ "America",
    Country %in% Oceania ~ "Oceania",
    TRUE ~ "Other")) %>%
  group_by(Continent)%>%
  summarise(AverageLifeExpectancy = mean(Life.expectancy, na.rm = TRUE))

ggplot(subset_continents, aes(x=Continent, y= AverageLifeExpectancy))+geom_col()+expand_limits(y=0)

```
```{r}
first_world_countries <- c(
  "Australia", "Andorra","Austria", "Belgium", "Canada", "Denmark",
  "Finland", "France", "Germany", "Greece", "Iceland", 
  "Ireland", "Italy", "Luxembourg", "Malta", "Netherlands",
  "New Zealand", "Norway", "Portugal", "Spain", "Sweden",
  "Switzerland", "United Kingdom", "United States","Estonia", "Poland", "Czech Republic","South Korea", "Japan"
)

second_world_countries <- c(
  "China","Brasil","Belarus", "Bosnia and Herzegovina", "Bulgaria",
  "Croatia", "Georgia", "Hungary",
  "Latvia", "Lithuania", "Moldova",
  "Montenegro", "Romania", "Russia", "Serbia",
  "Slovakia", "Slovenia", "Ukraine", "Nigeria", "Chile", "Costa Rica","Russian Federation"
)

third_world_countries <- c("Albania",
  setdiff(Africa, c("Nigeria")),
  setdiff(Oceania, c("Australia", "New Zealand")),
  setdiff(America, c("Canada", "United States", "Chile", "Costa Rica","Brasil")),
  setdiff(Asia, c("Japan", "South Korea", "China"))
)

add_developed <- clean_df %>%
mutate(Development = case_when(
    Country %in% first_world_countries ~ "First",
    Country %in% second_world_countries ~ "Second",
    Country %in% third_world_countries ~ "Third",
    TRUE ~ "Other")) %>%
  group_by(Development)

countries_classified_other <- add_developed %>%
  filter(Development == "Other") %>%
  distinct(Country) %>%
  pull(Country)

print(countries_classified_other)

```

```{r}
subset_developed <- clean_df %>%
mutate(Development = case_when(
    Country %in% first_world_countries ~ "First",
    Country %in% second_world_countries ~ "Second",
    Country %in% third_world_countries ~ "Third",
    TRUE ~ "Other")) %>%
  group_by(Development)%>%
  summarise(AverageLifeExpectancy = mean(Life.expectancy, na.rm = TRUE))

ggplot(subset_developed, aes(x=Development, y= AverageLifeExpectancy))+geom_col()+expand_limits(y=0)

```

```{r}
ggplot(clean_df, aes(x = Year, y = Life.expectancy)) +
  stat_summary(fun = mean, geom = "line") +
  labs(title = "Average Life Expectancy Over Years",
       x = "Year",
       y = "Average Life Expectancy")

ggplot(clean_df, aes(x = GDP, y = Life.expectancy)) +
  geom_point(alpha = 0.5) +
  labs(title = "Life Expectancy and GDP",
       x = "GDP",
       y = "Life Expectancy")
ggplot(clean_df, aes(x = Status, y = Life.expectancy, fill = Status)) +
  geom_boxplot() +
  labs(title = "Life Expectancy by Development Status",
       x = "Status",
       y = "Life Expectancy")

ggplot(add_developed, aes(x = BMI, y = Life.expectancy, color = Development, shape = Development)) +
  geom_point(alpha = 0.5) +
  labs(title = "Life Expectancy Over BMI by Development Status",
       x = "BMI",
       y = "Life Expectancy") +
  theme(legend.position = "right")


```
```{r}
# analyze missing values
# outliers boxplot
# colinearity, should we delete some features?
# pick some countries and analyze the correlation between xy linear, cubic...
# split training testing
# model <- lm(LifeExpectancy ~., data = train) # ~ . for all variables
# summary(model)
# predictes <- predict (model,newdata = test)
# mse(predicted, LifeExpectancy.test) # mean square error
```

```{r}
count_zeros <- colSums(df_tib == 0, na.rm = TRUE)

count_zeros_df <- data.frame(category = names(count_zeros), CountOfZeros = count_zeros)


ggplot(count_zeros_df, aes(x = category, y = CountOfZeros)) +
  geom_bar(stat = "identity", fill = "blue") +
  labs(title = "Count of Zeros or NaN's for eacg category", x = "Category", y = "Count") +
  theme_minimal() + 
  theme(axis.text.x = element_text(angle = 45, hjust = 1, vjust = 1, size = 8)) 

```

```{r}
# Your code with the necessary libraries loaded
subset_developed_full <- clean_df %>%
  mutate(Development = case_when(
    Country %in% first_world_countries ~ "First",
    Country %in% second_world_countries ~ "Second",
    Country %in% third_world_countries ~ "Third",
    TRUE ~ "Other")) %>%
  filter(Development == "First") %>%
  filter(Year == 2010) 

#subset_developed_full <- subset_developed_full %>%
#  mutate(IncomeLevel = cut(`Income.composition.of.resources`, 
#                           breaks = quantile(`Income.composition.of.resources`, 
#                                             probs = 0:2/2, na.rm = TRUE), 
#                           include.lowest = TRUE, 
#                           labels = c("Low", "High")))
##c("Low", "Medium-Low", "Medium-High", "High")))



```

```{r}

ggplot(subset_developed_full, aes(x = "", y = Income.composition.of.resources)) +
  geom_boxplot() +
  labs(y = "Income.composition.of.resources")

ggplot(subset_developed_full, aes(x = "", y = Adult.Mortality)) +
  geom_boxplot() +
  labs(y = "Adult.Mortality")

ggplot(subset_developed_full, aes(x = "", y = Schooling)) +
  geom_boxplot() +
  labs(y = "Schooling")

ggplot(subset_developed_full, aes(x = "", y = HIV.AIDS)) +
  geom_boxplot() +
  labs(y = "HIV")

ggplot(subset_developed_full, aes(x = "", y = BMI)) +
  geom_boxplot() +
  labs(y = "BMI")

ggplot(subset_developed_full, aes(x = "", y = Measles)) +
  geom_boxplot() +
  labs(y = "Measles")
```
```{r}
clean_df<-clean_df
clean_df$Year <- as.numeric(correlation_df$Year)
clean_df$Adult.Mortality <- as.numeric(correlation_df$Adult.Mortality )
clean_df$infant.deaths <- as.numeric(correlation_df$infant.deaths)
clean_df$Hepatitis.B <- as.numeric(correlation_df$Hepatitis.B)
clean_df$Measles <- as.numeric(correlation_df$Measles)
clean_df$under.five.deaths <- as.numeric(correlation_df$under.five.deaths)
clean_df$Polio <- as.numeric(correlation_df$Polio)
clean_df$Diphtheria <- as.numeric(correlation_df$Diphtheria)
clean_df<-correlation_df[ ,!(names(correlation_df) %in% c("Country", "Status"))]

set.seed(666)
train_indices <- sample(1:nrow(clean_df), 0.7 * nrow(clean_df))

train <- clean_df[train_indices, ]
test <- clean_df[-train_indices, ]
names(train)
```

model <- lm(LifeExpectancy ~., data = train_df)

predictions <- predict(model, new_data)




```{r}



model <- lm(Life.expectancy ~., data = train) # ~ . for all variables
summary(model)
```


```{r}
predicted <- predict (model, newdata = test)

mse <- mean((predicted-test$Life.expectancy)^2)
print(mse)
rmse <- RMSE(predicted, test$Life.expectancy)
print(rmse)
```

```{r}
model <- lm(Life.expectancy ~ Adult.Mortality+Income.composition.of.resources+Schooling+GDP+BMI,data = train)

summary(model)
```
```{r}
predicted <- predict (model, newdata = test)

mse <- mean((predicted-test$Life.expectancy)^2)
print(mse)
rmse <- RMSE(predicted, test$Life.expectancy)
print(rmse)
```




